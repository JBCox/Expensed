<div class="jensify-container">
  <!-- Header with Summary and Batch Actions -->
  <div class="jensify-page-header">
    <div class="jensify-header-content">
      <h1 class="jensify-page-title">Approval Queue</h1>
      <div class="jensify-summary-metrics">
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ totalPending() }}</span>
          <span class="jensify-metric-label">Pending</span>
        </div>
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ formatCurrency(totalAmount()) }}</span>
          <span class="jensify-metric-label">Total Amount</span>
        </div>
      </div>
    </div>

    <!-- Batch Actions -->
    @if (selectedCount() > 0) {
      <div class="jensify-batch-actions">
        <span class="jensify-selection-count">{{ selectedCount() }} selected</span>
        <button
          mat-raised-button
          class="jensify-approve-btn"
          (click)="approveSelected()">
          <mat-icon>done_all</mat-icon>
          Approve Selected
        </button>
        <button
          mat-stroked-button
          color="warn"
          (click)="rejectSelected()">
          <mat-icon>close</mat-icon>
          Reject Selected
        </button>
      </div>
    }
  </div>

  <!-- Filters -->
  <mat-card class="jensify-card jensify-filters-card">
    <div class="jensify-filter-row">
      <mat-form-field appearance="fill" floatLabel="always">
        <mat-icon matPrefix>search</mat-icon>
        <mat-label>Search by employee or merchant</mat-label>
        <input
          matInput
          [(ngModel)]="searchQuery"
          (ngModelChange)="searchQuery.set($event)">
      </mat-form-field>

      <mat-form-field appearance="fill" floatLabel="always">
        <mat-label>Category</mat-label>
        <mat-select
          [(ngModel)]="selectedCategory"
          (ngModelChange)="selectedCategory.set($event)">
          @for (option of categoryOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" floatLabel="always">
        <mat-label>From Date</mat-label>
        <input
          matInput
          [matDatepicker]="fromPicker"
          [(ngModel)]="dateFrom"
          (ngModelChange)="dateFrom.set($event)">
        <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" floatLabel="always">
        <mat-label>To Date</mat-label>
        <input
          matInput
          [matDatepicker]="toPicker"
          [(ngModel)]="dateTo"
          (ngModelChange)="dateTo.set($event)">
        <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
        <mat-datepicker #toPicker></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="jensify-flex-end jensify-mt-md">
      <button mat-button (click)="clearFilters()">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>
    </div>
  </mat-card>

  <!-- Loading State -->
  @if (loading()) {
    <app-loading-skeleton />
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <mat-card class="jensify-card error-card">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadPendingExpenses()">Retry</button>
    </mat-card>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && filteredExpenses().length === 0) {
    <app-empty-state
      icon="celebration"
      title="All caught up!"
      message="No pending expenses to review at this time.">
    </app-empty-state>
  }

  <!-- Approval Queue Table -->
  @if (!loading() && !error() && filteredExpenses().length > 0) {
    <mat-card class="jensify-card">
      <!-- Mobile: Cards with Virtual Scrolling -->
      <cdk-virtual-scroll-viewport itemSize="200" class="jensify-queue-viewport jensify-hide-desktop">
        <div class="jensify-mobile-queue">
          <div
            *cdkVirtualFor="let expense of filteredExpenses(); trackBy: trackByExpenseId"
            class="jensify-queue-item-mobile">
            <div class="jensify-item-header-mobile">
              <mat-checkbox
                [checked]="isSelected(expense.id)"
                (change)="toggleSelection(expense.id)">
              </mat-checkbox>
              <div class="jensify-employee-info">
                <span class="jensify-employee-name">{{ expense.user.full_name || 'Unknown' }}</span>
                <span class="jensify-employee-meta">{{ formatDate(expense.expense_date) }}</span>
              </div>
            </div>

            <div class="jensify-item-body-mobile">
              <div class="jensify-flex-col jensify-gap-sm">
                <span class="jensify-merchant-name">{{ expense.merchant }}</span>
                <span class="jensify-employee-meta">{{ expense.category }}</span>
              </div>
              <span class="jensify-amount">{{ formatCurrency(expense.amount) }}</span>
            </div>

            <div class="jensify-flex jensify-gap-sm jensify-mt-sm">
              <button
                mat-button
                (click)="viewReceipt(expense)"
                [disabled]="!expense.receipt"
                class="jensify-full-width">
                <mat-icon>description</mat-icon>
                {{ expense.receipt ? 'Receipt' : 'No Receipt' }}
              </button>
              <button
                mat-raised-button
                class="jensify-approve-btn jensify-button-sm jensify-full-width"
                (click)="approveExpense(expense.id)">
                <mat-icon>done</mat-icon>
                Approve
              </button>
              <button
                mat-stroked-button
                color="warn"
                class="jensify-button-sm jensify-full-width"
                (click)="rejectExpense(expense.id)">
                <mat-icon>close</mat-icon>
                Reject
              </button>
            </div>
          </div>
        </div>
      </cdk-virtual-scroll-viewport>

      <!-- Desktop: Table with Virtual Scrolling -->
      <cdk-virtual-scroll-viewport itemSize="80" class="jensify-queue-viewport jensify-hide-mobile">
        <div class="jensify-desktop-queue">
          <div
            *cdkVirtualFor="let expense of filteredExpenses(); trackBy: trackByExpenseId"
            class="jensify-queue-row">
            <mat-checkbox
              [checked]="isSelected(expense.id)"
              (change)="toggleSelection(expense.id)">
            </mat-checkbox>

            <div class="jensify-column">
              <span class="jensify-employee-name">{{ expense.user.full_name || 'Unknown' }}</span>
            </div>

            <div class="jensify-column">
              <span class="jensify-column-value">{{ expense.merchant }}</span>
              <span class="jensify-employee-meta">{{ expense.category }}</span>
            </div>

            <div class="jensify-column">
              <span class="jensify-column-value">{{ formatDate(expense.expense_date) }}</span>
            </div>

            <div class="jensify-column">
              <span class="jensify-amount">{{ formatCurrency(expense.amount) }}</span>
            </div>

            <div class="jensify-column">
              <button
                mat-stroked-button
                class="jensify-button-sm"
                (click)="viewReceipt(expense)"
                [disabled]="!expense.receipt">
                <mat-icon>description</mat-icon>
                Receipt
              </button>
            </div>

            <div class="jensify-column jensify-flex jensify-gap-sm">
              <button
                mat-icon-button
                class="jensify-approve-btn"
                (click)="approveExpense(expense.id)"
                matTooltip="Approve">
                <mat-icon>done</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="rejectExpense(expense.id)"
                matTooltip="Reject">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </cdk-virtual-scroll-viewport>
    </mat-card>
  }
</div>
