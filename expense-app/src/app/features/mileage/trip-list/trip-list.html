<div class="jensify-container">
  <!-- Pull to Refresh (mobile only) -->
  <app-pull-to-refresh
    [refreshing]="loading()"
    (refresh)="loadTrips()">
  </app-pull-to-refresh>

  <!-- Header with Summary -->
  <div class="jensify-page-header">
    <div class="jensify-header-content">
      <h1 class="jensify-page-title">Mileage</h1>
      <div class="jensify-summary-metrics">
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ totalCount() }}</span>
          <span class="jensify-metric-label">{{ totalCount() === 1 ? 'Trip' : 'Trips' }}</span>
        </div>
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ totalMiles().toFixed(1) }}</span>
          <span class="jensify-metric-label">Total Miles</span>
        </div>
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ formatCurrency(totalReimbursement()) }}</span>
          <span class="jensify-metric-label">Reimbursement</span>
        </div>
        @if (draftTrips().length > 0) {
          <div class="jensify-metric">
            <span class="jensify-metric-value">{{ draftTrips().length }}</span>
            <span class="jensify-metric-label">{{ draftTrips().length === 1 ? 'Draft' : 'Drafts' }}</span>
          </div>
        }
      </div>
    </div>
    <div class="jensify-header-actions">
      <button
        mat-raised-button
        color="primary"
        class="jensify-button"
        (click)="addNewTrip()">
        <mat-icon>add</mat-icon>
        Add Trip
      </button>
      <button
        mat-flat-button
        color="primary"
        class="jensify-export-btn jensify-button"
        (click)="exportToCSV()"
        [disabled]="filteredTrips().length === 0">
        <mat-icon>download</mat-icon>
        Export
      </button>
    </div>
  </div>

  <!-- Batch Action Bar (appears when trips are selected) -->
  @if (selectedCount() > 0) {
    <mat-card class="jensify-card jensify-batch-action-bar">
      <div class="jensify-batch-content">
        <mat-checkbox
          [checked]="allDraftsSelected()"
          [indeterminate]="selectedCount() > 0 && !allDraftsSelected()"
          (change)="toggleSelectAll()">
        </mat-checkbox>
        <span class="jensify-selection-count">
          {{ selectedCount() }} trip{{ selectedCount() > 1 ? 's' : '' }} selected
        </span>
      </div>
      <div class="jensify-batch-actions">
        <button mat-button (click)="clearSelection()" class="jensify-button">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
        <button
          mat-raised-button
          color="primary"
          class="jensify-button"
          (click)="submitSelected()"
          [disabled]="submittingBatch()">
          <mat-icon>send</mat-icon>
          Submit for Approval
        </button>
      </div>
    </mat-card>
  }

  <!-- Statistics Widget -->
  <app-mileage-stats-widget
    [startDate]="filterState().dateFrom?.toISOString()"
    [endDate]="filterState().dateTo?.toISOString()"
    [showBreakdown]="true">
  </app-mileage-stats-widget>

  <!-- Filters Component -->
  <app-trip-filters
    [filters]="filterState()"
    [showAdvanced]="showAdvancedFilters"
    [activeFilterCount]="activeFilterCount()"
    (filtersChange)="onFiltersChange($event)"
    (toggleAdvanced)="toggleAdvancedFilters()"
    (clearFilters)="clearFilters()">
  </app-trip-filters>

  <!-- Loading State -->
  @if (loading()) {
    <app-loading-skeleton />
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <mat-card class="jensify-card error-card">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadTrips()">Retry</button>
    </mat-card>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && filteredTrips().length === 0 && trips().length === 0) {
    <app-empty-state
      icon="directions_car"
      title="No trips yet"
      message="Log your first business trip to start tracking mileage reimbursement."
      actionLabel="Add Trip"
      actionIcon="add"
      (actionClick)="addNewTrip()">
    </app-empty-state>
  }

  <!-- No Results Empty State -->
  @if (!loading() && !error() && filteredTrips().length === 0 && trips().length > 0) {
    <app-empty-state
      icon="filter_alt_off"
      title="No trips match your filters"
      message="Try adjusting your filter criteria to see more results."
      actionLabel="Clear Filters"
      actionIcon="clear"
      (actionClick)="clearFilters()">
    </app-empty-state>
  }

  <!-- Trip Cards List with Virtual Scrolling -->
  @if (!loading() && !error() && filteredTrips().length > 0) {
    <cdk-virtual-scroll-viewport
      itemSize="280"
      class="jensify-trip-cards-viewport">
      <div class="jensify-trip-cards">
        <mat-card
          *cdkVirtualFor="let trip of filteredTrips(); trackBy: trackByTripId"
          class="jensify-card jensify-trip-card"
          [class.selected]="isSelected(trip.id)"
          role="article"
          [attr.aria-label]="'Trip on ' + formatDate(trip.trip_date) + ' from ' + trip.origin_address + ' to ' + trip.destination_address + ', ' + trip.total_miles + ' miles, status ' + trip.status + ', reimbursement ' + formatCurrency(trip.reimbursement_amount)">

          <!-- Card Header Row: Checkbox + Icon + Route + Amount -->
          <div class="trip-card-header">
            <!-- Left: Checkbox (drafts only) + Car Icon -->
            <div class="trip-card-left">
              @if (trip.status === 'draft') {
                <mat-checkbox
                  [checked]="isSelected(trip.id)"
                  (change)="toggleSelection(trip)"
                  (click)="$event.stopPropagation()"
                  class="trip-checkbox"
                  [attr.aria-label]="'Select trip'">
                </mat-checkbox>
              }
              <div class="trip-icon">
                <mat-icon>directions_car</mat-icon>
              </div>
            </div>

            <!-- Center: Route Info -->
            <div class="trip-card-center">
              <div class="trip-route">
                <div class="route-line">
                  <mat-icon class="route-icon origin">place</mat-icon>
                  <span class="route-address">{{ trip.origin_address }}</span>
                </div>
                <div class="route-line">
                  <mat-icon class="route-icon destination">location_on</mat-icon>
                  <span class="route-address">{{ trip.destination_address }}</span>
                </div>
              </div>
              <app-status-badge [status]="getStatusBadge(trip.status)" class="trip-status" />
            </div>

            <!-- Right: Amount -->
            <div class="trip-card-right">
              <span class="trip-amount-value">{{ formatCurrency(trip.reimbursement_amount) }}</span>
              <span class="trip-amount-label">Reimbursement</span>
            </div>
          </div>

          <!-- Meta Row: Date, Category, Purpose -->
          <div class="trip-card-meta">
            <div class="meta-item">
              <mat-icon>event</mat-icon>
              <span>{{ formatDate(trip.trip_date) }}</span>
            </div>
            <div class="meta-item">
              <mat-icon>business_center</mat-icon>
              <span>{{ trip.category }}</span>
            </div>
            <div class="meta-item">
              <mat-icon>description</mat-icon>
              <span>{{ trip.purpose || '(No purpose)' }}</span>
            </div>
          </div>

          <!-- Mileage Info Row -->
          <div class="trip-card-mileage">
            <div class="mileage-item">
              <span class="mileage-label">Distance</span>
              <span class="mileage-value">
                {{ trip.distance_miles }} mi
                @if (trip.distance_manually_modified) {
                  <mat-icon class="modified-icon" matTooltip="Manually modified">warning</mat-icon>
                }
              </span>
            </div>
            <div class="mileage-item">
              <span class="mileage-label">Total</span>
              <span class="mileage-value">{{ trip.total_miles }} mi</span>
            </div>
            <div class="mileage-item">
              <span class="mileage-label">Rate</span>
              <span class="mileage-value">${{ trip.irs_rate.toFixed(3) }}/mi</span>
            </div>
          </div>

          <!-- Notes (if any) -->
          @if (trip.notes) {
            <div class="trip-card-notes">{{ trip.notes }}</div>
          }

          <!-- Actions Row -->
          <div class="trip-card-actions">
            <button mat-button (click)="goToDetails(trip)" class="action-btn">
              <mat-icon>visibility</mat-icon>
              Details
            </button>
            @if (canConvertToExpense(trip)) {
              <button mat-button color="accent" (click)="convertToExpense(trip)" class="action-btn">
                <mat-icon>receipt_long</mat-icon>
                To Expense
              </button>
            }
            @if (trip.expense_id) {
              <button mat-button (click)="viewLinkedExpense(trip)" class="action-btn">
                <mat-icon>open_in_new</mat-icon>
                View Expense
              </button>
            }
            @if (trip.status === 'draft') {
              <button mat-button color="primary" (click)="goToEdit(trip)" class="action-btn">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
              <button mat-button color="warn" (click)="deleteTrip(trip)" class="action-btn">
                <mat-icon>delete</mat-icon>
                Delete
              </button>
            }
          </div>
        </mat-card>
      </div>
    </cdk-virtual-scroll-viewport>
  }
</div>
